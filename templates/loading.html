<!-- loading.html -->
<h1>Loading Services...</h1>
<p>Waiting for services to start...</p>
 
<!-- 
  CHANGE: Added a simple CSS block for spinner/check icons.
  (Optional: Could be moved to a separate CSS file if desired.)
-->
<style>
    .spinner {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid #ccc;
        border-top-color: #333;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 8px;
    }
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    .check {
        color: green;
        font-weight: bold;
        margin-right: 8px;
    }
</style>
 
<ul id="services-list">
    {% for service, port in services.items() %}
<li>
<!-- 
          CHANGE: Added a <span> element for displaying spinner/check icon.
          Everything else in the list item remains as before. 
        -->
<span id="icon-{{ service }}" class="spinner"></span>
<label>
<input type="checkbox" id="checkbox-{{ service }}" disabled>
            {{ service }} (Port: {{ port }})
</label>
</li>
    {% endfor %}
</ul>
 
<!-- Include a script to poll the service status -->
<script>
    const services = {{ services | tojson }};  // Pass services and ports from the backend
 
    /*
      CHANGE: Replaced the original synchronous .every() approach with an 
      asynchronous Promise.all approach. Now each service is checked in parallel, 
      and the UI is updated for each service individually (spinner -> check).
    */
    async function checkServiceStatus() {
        // Create Promises for each service check
        const statusPromises = Object.entries(services).map(async ([service, port]) => {
            let isUp = false;
            try {
                // Attempt to fetch from the port
                const response = await fetch(`http://localhost:${port}`, { method: 'GET' });
                if (response.ok) {
                    isUp = true;
                }
            } catch (err) {
                // If fetch fails or times out, service is not up yet
                isUp = false;
            }
 
            // Update the DOM icon and checkbox state for each service
            const iconEl = document.getElementById(`icon-${service}`);
            const checkboxEl = document.getElementById(`checkbox-${service}`);
            if (isUp) {
                iconEl.classList.remove('spinner');
                iconEl.classList.add('check');
                iconEl.textContent = 'âœ”';
                checkboxEl.checked = true;
            } else {
                // Revert to spinner if not up
                iconEl.textContent = '';
                iconEl.classList.remove('check');
                iconEl.classList.add('spinner');
                checkboxEl.checked = false;
            }
 
            return isUp;
        });
 
        // Wait for all fetches to complete
        const results = await Promise.all(statusPromises);
        // Check if all are up
        if (results.every(Boolean)) {
            // Redirect to final page once all services are up
            window.location.href = "/final";
        } else {
            // Poll again every 2 seconds
            setTimeout(checkServiceStatus, 2000);
        }
    }
 
    // Start checking the service status when the page loads
    window.onload = checkServiceStatus;
</script>